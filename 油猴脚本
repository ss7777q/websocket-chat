// ==UserScript==
// @name         testé€ æ¢¦æ— åŒ
// @namespace    http://tampermonkey.net/
// @version      1.6
// @description  é€šè¿‡WebSocketæ¡¥æ¥å™¨è¿æ¥æœ¬åœ°æœåŠ¡å™¨ï¼Œå®æ—¶è½¬å‘æ¸¸æˆæ•°æ®
// @author       Claude
// @match        https://client-zmxyol.3304399.net/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ======== åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤ºæ¡† ======== ï¼ˆä¿æŒä½ åŸæœ‰UIé€»è¾‘ï¼‰
    const statusBox = (function createStatusBox() {
        const div = document.createElement('div');
        div.id = 'zw-status';
        div.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            z-index: 9999;
            max-width: 300px;
        `;
        div.innerHTML = 'ğŸŸ¡ è¿æ¥åˆå§‹åŒ–ä¸­...';
        document.body.appendChild(div);
        return div;
    })();

    function updateStatus(text, color = 'white', emoji = 'âšª') {
        statusBox.innerHTML = `${emoji} ${text}`;
        statusBox.style.color = color;
    }

    // ======== WebSocketè¿æ¥æ ¸å¿ƒ ========
    let retryCount = 0;
    const MAX_RETRIES = 5;

    function connectToServer(socketManager) {
        const ws = new WebSocket('ws://localhost:3000/game-relay');

        ws.onopen = () => {
            retryCount = 0;
            updateStatus('æœåŠ¡å™¨è¿æ¥æˆåŠŸ', '#90EE90', 'ğŸŸ¢');
        };

        ws.onmessage = async (event) => {
            const uid = event.data.toString().trim();
            if (!uid) return;

            updateStatus(`æ¥æ”¶UID: ${uid}`, '#87CEEB', 'ğŸ“¥');
            try {
                const userInfo = await new Promise((resolve, reject) => {
                    socketManager.reqServer(
                        "scene.playerHandler.getUserInfo",
                        { uid: uid },
                        response => response.code === 200 ? resolve(response.userInfo) : reject(response),
                        error => reject(error || 'è¯·æ±‚è¶…æ—¶')
                    );
                });

                ws.send(JSON.stringify({
                    type: 'success',
                    uid: uid,
                    data: userInfo
                }));
                updateStatus(`å‘é€æˆåŠŸ UID:${uid}`, '#98FB98', 'ğŸ“¤');
            } catch (error) {
                ws.send(JSON.stringify({
                    type: 'error',
                    uid: uid,
                    message: error.message || `é”™è¯¯ä»£ç : ${error.code || 'æœªçŸ¥'}`
                }));
                updateStatus(`æŸ¥è¯¢å¤±è´¥: ${error.message || error.code}`, '#FFB6C1', 'âŒ');
            }
        };

        ws.onerror = (err) => {
            updateStatus(`è¿æ¥é”™è¯¯: ${err.message || 'æœªçŸ¥'}`, '#FFA07A', 'âš ï¸');
            scheduleReconnect();
        };

        ws.onclose = () => {
            updateStatus('è¿æ¥å·²å…³é—­', '#D3D3D3', 'âšª');
            scheduleReconnect();
        };
    }

    function scheduleReconnect() {
        if (retryCount++ < MAX_RETRIES) {
            updateStatus(`å°è¯•é‡æ–°è¿æ¥ (${retryCount}/${MAX_RETRIES})...`, 'orange', 'ğŸ”„');
            setTimeout(() => initConnection(), 3000 * retryCount);
        } else {
            updateStatus('æ°¸ä¹…ç¦»çº¿', '#FF6347', 'ğŸ”´');
        }
    }

    // ======== ä¸»åˆå§‹åŒ–æµç¨‹ ========
    function initConnection() {
        // æ£€æµ‹æ¸¸æˆæ ¸å¿ƒå¯¹è±¡
        window.socketManager
            ? (updateStatus('æ£€æµ‹åˆ°socketManager', '#F0E68C', 'ğŸ”'), connectToServer(window.socketManager))
            : setTimeout(() => window.socketManager ? connectToServer(window.socketManager) : initConnection(), 1000);
    }

    // æ¸¸æˆåŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨
    if (document.readyState === 'complete') {
        initConnection();
    } else {
        window.addEventListener('load', initConnection);
    }
})();
